<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Anuncios - ODUO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: rgba(14, 165, 233, 0.3); }
            50% { border-color: rgba(14, 165, 233, 0.8); }
        }
        .pulse-border {
            animation: pulse-border 2s ease-in-out infinite;
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .keyword-item:hover {
            background: rgba(14, 165, 233, 0.1);
        }

        .ad-card {
            transition: all 0.2s ease;
        }
        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="dark bg-gray-900 min-h-screen">
    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/95 backdrop-blur sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-emerald-500 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Gerador de Anuncios</h1>
                        <p class="text-xs text-gray-400">ODUO - Ferramenta Interna</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1 bg-gray-800 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs text-gray-400">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Formulário Principal -->
        <section class="bg-gray-800 rounded-2xl p-6 mb-6 border border-gray-700">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 bg-primary-600/20 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-white">Data Hunter + Ad-Intelligence</h2>
                    <p class="text-sm text-gray-400">Scraper de palavras-chave reais + Modelagem de anúncios vencedores</p>
                </div>
            </div>

            <form id="mainForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label for="ramo" class="block text-sm font-medium text-gray-300 mb-2">
                            Ramo/Segmento *
                            <span class="text-xs text-gray-500 font-normal">(para scraping)</span>
                        </label>
                        <input type="text" id="ramo" placeholder="Ex: locação de equipamentos"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="localizacao" class="block text-sm font-medium text-gray-300 mb-2">
                            Localização *
                            <span class="text-xs text-gray-500 font-normal">(Cidade/Estado)</span>
                        </label>
                        <input type="text" id="localizacao" placeholder="Ex: Curitiba PR"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="oferta" class="block text-sm font-medium text-gray-300 mb-2">Oferta Principal *</label>
                        <input type="text" id="oferta" placeholder="Ex: Locação de Geradores"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="cliente" class="block text-sm font-medium text-gray-300 mb-2">Nome do Cliente *</label>
                        <input type="text" id="cliente" placeholder="Ex: PowerTech Geradores"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="nicho" class="block text-sm font-medium text-gray-300 mb-2">Nicho/Público *</label>
                        <input type="text" id="nicho" placeholder="Ex: Construtoras e eventos"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                    </div>
                </div>

                <div class="flex justify-center pt-2">
                    <button type="submit" id="generateBtn"
                        class="px-8 py-4 bg-gradient-to-r from-primary-600 to-emerald-600 hover:from-primary-500 hover:to-emerald-500 text-white font-semibold rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg shadow-primary-900/30 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btnText">Iniciar Pipeline Completo</span>
                        <svg id="btnIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <svg id="btnSpinner" class="w-5 h-5 spinner hidden" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </section>

        <!-- Status do Pipeline -->
        <section id="pipelineStatus" class="hidden mb-6">
            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                <div class="flex items-center gap-4">
                    <div id="step1Status" class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-400">1</span>
                        </div>
                        <span class="text-sm text-gray-400">Data Hunter</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-700"></div>
                    <div id="step2Status" class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-400">2</span>
                        </div>
                        <span class="text-sm text-gray-400">Ad-Intelligence</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-700"></div>
                    <div id="step3Status" class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-400">3</span>
                        </div>
                        <span class="text-sm text-gray-400">Pronto!</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Banner de Fallback (quando usa IA) -->
        <section id="fallbackBanner" class="hidden mb-6">
            <div class="bg-amber-900/30 border border-amber-700/50 rounded-xl p-4 flex items-center gap-4">
                <div class="w-10 h-10 bg-amber-600/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <p id="fallbackTitle" class="text-amber-300 font-medium text-sm">Busca expandida</p>
                    <p id="fallbackMessage" class="text-amber-200/70 text-xs mt-0.5"></p>
                </div>
                <span id="fallbackBadge" class="px-3 py-1 bg-amber-600/30 text-amber-300 text-xs font-medium rounded-full"></span>
            </div>
        </section>

        <!-- Resultados Split View -->
        <section id="resultsSection" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coluna Esquerda: Palavras-Chave Reais -->
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
                    <div class="p-4 border-b border-gray-700 bg-gray-800/80">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-emerald-600/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white">Palavras-Chave Reais</h3>
                                    <p id="keywordCount" class="text-xs text-gray-400">0 termos encontrados</p>
                                </div>
                            </div>
                            <button onclick="copyAllKeywords()"
                                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                Copiar Tudo
                            </button>
                        </div>
                    </div>
                    <div id="keywordsList" class="max-h-[600px] overflow-y-auto custom-scrollbar p-2">
                        <!-- Keywords serão inseridas aqui -->
                    </div>
                </div>

                <!-- Coluna Direita: Anúncios Vencedores -->
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
                    <div class="p-4 border-b border-gray-700 bg-gray-800/80">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-600/20 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Anúncios Vencedores</h3>
                                <p class="text-xs text-gray-400">Modelados dos top performers</p>
                            </div>
                        </div>
                    </div>
                    <div id="adsList" class="max-h-[600px] overflow-y-auto custom-scrollbar p-4 space-y-4">
                        <!-- Ads serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Erro -->
        <section id="errorSection" class="hidden">
            <div class="bg-red-900/20 border border-red-800 rounded-xl p-6 text-center">
                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h3 class="text-lg font-semibold text-red-400 mb-2">Erro no Pipeline</h3>
                <p id="errorMessage" class="text-gray-400"></p>
                <button onclick="resetUI()" class="mt-4 px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors">
                    Tentar Novamente
                </button>
            </div>
        </section>

        <!-- Seção de Ativos Massivos para Google Ads Responsivo -->
        <section id="assetsSection" class="hidden mt-8">
            <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
                <!-- Header da Seção -->
                <div class="p-4 border-b border-gray-700 bg-gradient-to-r from-orange-900/30 to-amber-900/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-orange-600/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Ativos para Anúncio Responsivo</h3>
                                <p class="text-xs text-gray-400">15 Títulos + 4 Descrições prontos para Google Ads</p>
                            </div>
                        </div>
                        <button id="generateAssetsBtn" onclick="generateAssets()"
                            class="px-5 py-2.5 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 text-white text-sm font-medium rounded-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="assetsBtnText">Gerar Ativos</span>
                            <svg id="assetsBtnIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <svg id="assetsBtnSpinner" class="w-4 h-4 spinner hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Conteúdo dos Ativos -->
                <div id="assetsContent" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-gray-700">
                        <!-- Coluna de Títulos -->
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-orange-400">Títulos</span>
                                    <span class="text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded">máx. 30 caracteres</span>
                                </div>
                                <button onclick="copyAllTitles()" class="text-xs text-gray-400 hover:text-white transition-colors flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    Copiar Todos
                                </button>
                            </div>
                            <div id="titlesList" class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                                <!-- Títulos serão inseridos aqui -->
                            </div>
                        </div>

                        <!-- Coluna de Descrições -->
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-amber-400">Descrições</span>
                                    <span class="text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded">máx. 90 caracteres</span>
                                </div>
                                <button onclick="copyAllDescriptions()" class="text-xs text-gray-400 hover:text-white transition-colors flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    Copiar Todas
                                </button>
                            </div>
                            <div id="descriptionsList" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                                <!-- Descrições serão inseridas aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder antes de gerar -->
                <div id="assetsPlaceholder" class="p-8 text-center">
                    <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <p class="text-gray-500 text-sm">Clique em "Gerar Ativos" para criar títulos e descrições<br>otimizados para Anúncios Responsivos do Google Ads</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <p class="text-center text-sm text-gray-500">
                Gerador de Anuncios | ODUO | Powered by GPT-4o
            </p>
        </div>
    </footer>

    <script>
        // =============================================
        // CONFIGURAÇÃO
        // =============================================
        const API_URL = window.location.origin;
        const TIMEOUT = 120000; // 2 min para o pipeline completo

        let currentKeywords = [];

        // =============================================
        // UTILITIES
        // =============================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
            const icon = type === 'success'
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
            toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg><span>${message}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setLoading(isLoading, step = '') {
            document.getElementById('generateBtn').disabled = isLoading;
            document.getElementById('btnIcon').classList.toggle('hidden', isLoading);
            document.getElementById('btnSpinner').classList.toggle('hidden', !isLoading);

            if (isLoading) {
                document.getElementById('btnText').textContent = step || 'Processando...';
                document.getElementById('pipelineStatus').classList.remove('hidden');
            } else {
                document.getElementById('btnText').textContent = 'Iniciar Pipeline Completo';
            }
        }

        function updatePipelineStep(step, status) {
            const stepEl = document.getElementById(`step${step}Status`);
            const circle = stepEl.querySelector('div');
            const text = stepEl.querySelector('span');

            if (status === 'active') {
                circle.className = 'w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center pulse-border border-2';
                text.className = 'text-sm text-primary-400 font-medium';
            } else if (status === 'done') {
                circle.className = 'w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center';
                circle.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                text.className = 'text-sm text-emerald-400 font-medium';
            }
        }

        function resetUI() {
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('pipelineStatus').classList.add('hidden');
            setLoading(false);
        }

        // =============================================
        // RENDER FUNCTIONS
        // =============================================
        function renderKeywords(keywords, source = 'google_autocomplete') {
            currentKeywords = keywords;

            // Atualiza título baseado na fonte
            const titleEl = document.querySelector('#resultsSection h3');
            const countEl = document.getElementById('keywordCount');

            if (source === 'ia_prediction') {
                countEl.innerHTML = `${keywords.length} termos <span class="text-amber-400">(Previsão IA)</span>`;
            } else if (source === 'sem_localizacao') {
                countEl.innerHTML = `${keywords.length} termos <span class="text-blue-400">(Nacional)</span>`;
            } else {
                countEl.textContent = `${keywords.length} termos encontrados`;
            }

            const html = keywords.map((kw, i) => `
                <div class="keyword-item px-3 py-2 rounded-lg text-sm text-gray-300 cursor-pointer transition-colors flex items-center justify-between group fade-in" style="animation-delay: ${Math.min(i * 20, 500)}ms">
                    <span class="truncate">${kw}</span>
                    <button onclick="copyKeyword('${kw.replace(/'/g, "\\'")}')" class="opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-700 rounded transition-all">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            document.getElementById('keywordsList').innerHTML = html;
        }

        function getIntencaoBadge(intencao) {
            const colors = {
                'Fundo de Funil': 'bg-green-900/50 text-green-400 border-green-700',
                'Meio de Funil': 'bg-yellow-900/50 text-yellow-400 border-yellow-700',
                'Topo de Funil': 'bg-blue-900/50 text-blue-400 border-blue-700'
            };
            // Normaliza o texto
            const normalized = intencao.includes('Fundo') ? 'Fundo de Funil'
                : intencao.includes('Topo') ? 'Topo de Funil'
                : 'Meio de Funil';
            return `<span class="px-2 py-1 ${colors[normalized]} text-xs font-medium rounded border">${normalized}</span>`;
        }

        function renderAds(ads) {
            const html = ads.map((ad, i) => {
                const anuncio = ad.anuncio_vencedor;
                const fullText = `${anuncio.titulo}\n\n${anuncio.descricao}\n\nCTA: ${anuncio.cta}`;

                return `
                    <div class="ad-card bg-gray-900/50 rounded-xl border border-gray-700 p-5 fade-in" style="animation-delay: ${i * 100}ms">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex flex-wrap items-center gap-2">
                                ${getIntencaoBadge(ad.intencao)}
                                <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">
                                    "${ad.termo_real}"
                                </span>
                            </div>
                            <button onclick="copyAdToClipboard(\`${fullText.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, this)"
                                class="text-gray-400 hover:text-white transition-colors p-1" title="Copiar anúncio">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Conteúdo do Anúncio -->
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 uppercase tracking-wide">Título</label>
                                <p class="text-white font-semibold mt-1">${anuncio.titulo}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 uppercase tracking-wide">Descrição</label>
                                <p class="text-gray-300 mt-1 text-sm leading-relaxed whitespace-pre-line">${anuncio.descricao}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 uppercase tracking-wide">CTA</label>
                                <div class="mt-2">
                                    <span class="inline-block px-4 py-2 bg-gradient-to-r from-primary-600 to-emerald-600 text-white text-sm font-medium rounded-lg">${anuncio.cta}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Por que funciona -->
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <div class="flex items-start gap-2">
                                <svg class="w-4 h-4 text-purple-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <div>
                                    <label class="text-xs text-purple-400 font-medium uppercase tracking-wide">Por que funciona</label>
                                    <p class="text-gray-400 text-xs mt-1">${ad.por_que_funciona}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('adsList').innerHTML = html;
        }

        // =============================================
        // COPY FUNCTIONS
        // =============================================
        async function copyKeyword(keyword) {
            try {
                await navigator.clipboard.writeText(keyword);
                showToast('Keyword copiada!');
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        async function copyAllKeywords() {
            try {
                await navigator.clipboard.writeText(currentKeywords.join('\n'));
                showToast(`${currentKeywords.length} keywords copiadas!`);
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        async function copyAdToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                showToast('Anúncio copiado!');
                setTimeout(() => { button.innerHTML = originalHTML; }, 2000);
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        // =============================================
        // MAIN FORM HANDLER
        // =============================================
        document.getElementById('mainForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                ramo: document.getElementById('ramo').value.trim(),
                localizacao: document.getElementById('localizacao').value.trim(),
                oferta: document.getElementById('oferta').value.trim(),
                cliente: document.getElementById('cliente').value.trim(),
                nicho: document.getElementById('nicho').value.trim()
            };

            if (!formData.ramo || !formData.localizacao || !formData.oferta || !formData.cliente || !formData.nicho) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            // Reset e inicia
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('fallbackBanner').classList.add('hidden');
            setLoading(true, 'Iniciando Data Hunter...');
            updatePipelineStep(1, 'active');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);

            try {
                const response = await fetch(`${API_URL}/full_pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const result = await response.json();

                if (result.success) {
                    // Step 1 done
                    updatePipelineStep(1, 'done');

                    // Verifica se usou fallback e atualiza mensagem
                    const fallbackUsed = result.data.fallback_used;
                    if (fallbackUsed) {
                        if (fallbackUsed === 'sem_localizacao') {
                            setLoading(true, 'Expandindo busca nacional...');
                        } else if (fallbackUsed === 'ia_prediction') {
                            setLoading(true, 'Gerando keywords com IA...');
                        }
                        await new Promise(r => setTimeout(r, 400));
                    }

                    setLoading(true, 'Processando Ad-Intelligence...');
                    updatePipelineStep(2, 'active');

                    // Pequena pausa para efeito visual
                    await new Promise(r => setTimeout(r, 500));

                    updatePipelineStep(2, 'done');
                    updatePipelineStep(3, 'active');

                    await new Promise(r => setTimeout(r, 300));
                    updatePipelineStep(3, 'done');

                    // Mostra banner de fallback se usado
                    if (fallbackUsed) {
                        const banner = document.getElementById('fallbackBanner');
                        const titleEl = document.getElementById('fallbackTitle');
                        const messageEl = document.getElementById('fallbackMessage');
                        const badgeEl = document.getElementById('fallbackBadge');

                        if (fallbackUsed === 'sem_localizacao') {
                            titleEl.textContent = 'Busca expandida para todo o Brasil';
                            messageEl.textContent = result.data.fallback_message || 'Não encontramos resultados locais, mas expandimos a busca nacional.';
                            badgeEl.textContent = 'Nacional';
                        } else if (fallbackUsed === 'ia_prediction') {
                            titleEl.textContent = 'Palavras-chave geradas por IA';
                            messageEl.textContent = result.data.fallback_message || 'Usamos inteligência artificial para prever os termos de maior volume.';
                            badgeEl.textContent = 'Previsão IA';
                        }

                        banner.classList.remove('hidden');
                    }

                    // Renderiza resultados (com source info)
                    renderKeywords(result.data.keywords.list, result.data.keywords.source);
                    renderAds(result.data.ads);

                    document.getElementById('resultsSection').classList.remove('hidden');

                    const sourceLabel = fallbackUsed === 'ia_prediction' ? '(IA)' : fallbackUsed === 'sem_localizacao' ? '(Nacional)' : '';
                    showToast(`Pipeline completo! ${result.data.keywords.total} keywords ${sourceLabel} + ${result.data.ads.length} anúncios`);

                    // Auto-gera os ativos (títulos + descrições) automaticamente
                    await generateAssets();

                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                clearTimeout(timeoutId);
                document.getElementById('errorMessage').textContent =
                    error.name === 'AbortError' ? 'Timeout - tente novamente' : error.message || 'Erro de conexão';
                document.getElementById('errorSection').classList.remove('hidden');
                showToast('Erro no pipeline', 'error');
            } finally {
                setLoading(false);
            }
        });

        // =============================================
        // ATIVOS MASSIVOS - Google Ads Responsivo
        // =============================================
        let currentAssets = { titulos: [], descricoes: [] };

        function setAssetsLoading(isLoading) {
            document.getElementById('generateAssetsBtn').disabled = isLoading;
            document.getElementById('assetsBtnText').textContent = isLoading ? 'Gerando...' : 'Gerar Ativos';
            document.getElementById('assetsBtnIcon').classList.toggle('hidden', isLoading);
            document.getElementById('assetsBtnSpinner').classList.toggle('hidden', !isLoading);
        }

        function renderAssets(assets) {
            currentAssets = assets;

            // Renderiza Títulos
            const titlesHtml = assets.titulos.map((titulo, i) => `
                <div class="flex items-center justify-between bg-gray-900/50 rounded-lg px-3 py-2 group hover:bg-gray-900 transition-colors fade-in" style="animation-delay: ${i * 50}ms">
                    <div class="flex-1 min-w-0">
                        <span class="text-sm text-gray-300 truncate block">${titulo}</span>
                        <span class="text-xs text-gray-600">${titulo.length}/30</span>
                    </div>
                    <button onclick="copyAssetItem('${titulo.replace(/'/g, "\\'")}', this)"
                        class="ml-2 p-1.5 text-gray-500 hover:text-orange-400 transition-colors opacity-0 group-hover:opacity-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
            `).join('');
            document.getElementById('titlesList').innerHTML = titlesHtml;

            // Renderiza Descrições
            const descriptionsHtml = assets.descricoes.map((desc, i) => `
                <div class="bg-gray-900/50 rounded-lg p-3 group hover:bg-gray-900 transition-colors fade-in" style="animation-delay: ${i * 100}ms">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1">
                            <p class="text-sm text-gray-300 leading-relaxed">${desc}</p>
                            <span class="text-xs text-gray-600 mt-1 block">${desc.length}/90</span>
                        </div>
                        <button onclick="copyAssetItem(\`${desc.replace(/`/g, '\\`')}\`, this)"
                            class="p-1.5 text-gray-500 hover:text-amber-400 transition-colors opacity-0 group-hover:opacity-100 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('descriptionsList').innerHTML = descriptionsHtml;

            // Mostra o conteúdo e esconde o placeholder
            document.getElementById('assetsContent').classList.remove('hidden');
            document.getElementById('assetsPlaceholder').classList.add('hidden');
        }

        async function copyAssetItem(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                showToast('Copiado!');
                setTimeout(() => { button.innerHTML = originalHTML; }, 1500);
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        async function copyAllTitles() {
            try {
                await navigator.clipboard.writeText(currentAssets.titulos.join('\n'));
                showToast(`${currentAssets.titulos.length} títulos copiados!`);
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        async function copyAllDescriptions() {
            try {
                await navigator.clipboard.writeText(currentAssets.descricoes.join('\n\n'));
                showToast(`${currentAssets.descricoes.length} descrições copiadas!`);
            } catch (err) {
                showToast('Erro ao copiar', 'error');
            }
        }

        async function generateAssets() {
            const formData = {
                ramo: document.getElementById('ramo').value.trim(),
                localizacao: document.getElementById('localizacao').value.trim(),
                oferta: document.getElementById('oferta').value.trim(),
                keywords: currentKeywords
            };

            if (!formData.ramo || !formData.localizacao || !formData.oferta) {
                showToast('Preencha Ramo, Localização e Oferta primeiro', 'error');
                return;
            }

            setAssetsLoading(true);

            try {
                const response = await fetch(`${API_URL}/generate_assets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    renderAssets(result.data);
                    showToast(`${result.data.titulos.length} títulos + ${result.data.descricoes.length} descrições gerados!`);
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                showToast(error.message || 'Erro ao gerar ativos', 'error');
            } finally {
                setAssetsLoading(false);
            }
        }

        // Mostra a seção de ativos quando o pipeline principal termina
        const originalRenderKeywords = renderKeywords;
        renderKeywords = function(keywords) {
            originalRenderKeywords(keywords);
            document.getElementById('assetsSection').classList.remove('hidden');
        };
    </script>
</body>
</html>
